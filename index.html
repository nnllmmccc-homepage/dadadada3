<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ€ãƒ¼</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;max-width:1000px;margin:0 auto;padding:20px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;color:#333}
.container{background:white;border-radius:15px;padding:30px;box-shadow:0 10px 30px rgba(0,0,0,0.2);margin:20px 0}
h1{text-align:center;margin-bottom:30px;color:#2c3e50}
.drop-area{border:3px dashed #3498db;border-radius:10px;padding:40px;text-align:center;cursor:pointer;background:#f8f9fa;transition:.3s}
.drop-area.dragover{background:#e3f2fd;border-color:#2980b9;transform:translateY(-2px)}
.file-input{display:none}
.btn{background:linear-gradient(45deg,#3498db,#2980b9);color:#fff;border:none;padding:12px 25px;border-radius:25px;cursor:pointer;font-size:16px;margin-top:15px;transition:.3s;box-shadow:0 4px 15px rgba(52,152,219,.3)}
.btn:hover{transform:translateY(-2px)}
.result-container{display:none;background:#fff;border-radius:10px;padding:25px;box-shadow:0 5px 15px rgba(0,0,0,.1);margin-top:20px;animation:fadeIn .5s ease}
.thumbnail{max-width:100%;max-height:300px;margin:15px 0;border-radius:8px;box-shadow:0 4px 10px rgba(0,0,0,.1)}
.link-box{background:#f8f9fa;border:2px solid #e9ecef;border-radius:8px;padding:15px;margin:20px 0;word-break:break-all;font-family:monospace}
.copy-btn{background:linear-gradient(45deg,#2ecc71,#27ae60)}
.status-text{margin-top:15px;color:#6c757d;font-size:14px}
@keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
</style>
</head>
<body>
<div class="container">
  <h1>ğŸ“¸ ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ€ãƒ¼</h1>
  <div class="drop-area" id="dropArea">
    <div style="font-size:48px;">ğŸ“</div>
    <p>ã“ã“ã«ç”»åƒã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</p>
    <p>ã¾ãŸã¯</p>
    <input type="file" id="fileInput" class="file-input" accept="image/*">
    <button class="btn" id="selectBtn">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</button>
  </div>

  <div class="result-container" id="resultContainer">
    <h2>âœ… ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸï¼</h2>
    <img id="previewImg" class="thumbnail" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼">
    <p>å…±æœ‰ãƒªãƒ³ã‚¯:</p>
    <div class="link-box" id="linkBox"></div>
    <button class="btn copy-btn" id="copyBtn">ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼</button>
    <p class="status-text" id="statusText"></p>
  </div>
</div>

<script>
const dropArea=document.getElementById('dropArea');
const fileInput=document.getElementById('fileInput');
const selectBtn=document.getElementById('selectBtn');
const resultContainer=document.getElementById('resultContainer');
const previewImg=document.getElementById('previewImg');
const linkBox=document.getElementById('linkBox');
const copyBtn=document.getElementById('copyBtn');
const statusText=document.getElementById('statusText');

let db;
const DB_NAME='ImageUploaderDB';
const DB_VERSION=3;
const STORE_NAME='images';
const currentBaseUrl=window.location.origin+window.location.pathname.replace(/\/$/,'');

// === IndexedDB åˆæœŸåŒ– ===
function initDatabase(){
  return new Promise((resolve,reject)=>{
    const request=indexedDB.open(DB_NAME,DB_VERSION);
    request.onerror=()=>reject(request.error);
    request.onsuccess=()=>{db=request.result;resolve()};
    request.onupgradeneeded=e=>{
      const db=e.target.result;
      if(!db.objectStoreNames.contains(STORE_NAME)){
        db.createObjectStore(STORE_NAME,{keyPath:'shortId'});
      }
    };
  });
}

function generateShortId(){
  const chars='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  let id='';for(let i=0;i<7;i++)id+=chars[Math.floor(Math.random()*chars.length)];
  return id;
}

function saveImageToDB(file,imageData){
  return new Promise((resolve,reject)=>{
    const shortId=generateShortId();
    const tx=db.transaction([STORE_NAME],'readwrite');
    const store=tx.objectStore(STORE_NAME);
    const record={shortId,filename:file.name,type:file.type,data:imageData,timestamp:Date.now()};
    const req=store.add(record);
    req.onsuccess=()=>resolve(shortId);
    req.onerror=()=>reject(req.error);
  });
}

async function handleFiles(files){
  if(!files.length)return;
  const file=files[0];
  if(!file.type.startsWith('image/')){alert('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');return;}
  const reader=new FileReader();
  reader.onload=async e=>{
    const data=e.target.result;
    try{
      const id=await saveImageToDB(file,data);
      const link=`${currentBaseUrl}/${id}`;
      previewImg.src=data;
      linkBox.textContent=link;
      resultContainer.style.display='block';
      statusText.textContent='';
    }catch(err){
      statusText.textContent='ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: '+err.message;
    }
  };
  reader.readAsDataURL(file);
}

selectBtn.onclick=()=>fileInput.click();
dropArea.addEventListener('dragover',e=>{e.preventDefault();dropArea.classList.add('dragover');});
dropArea.addEventListener('dragleave',()=>dropArea.classList.remove('dragover'));
dropArea.addEventListener('drop',e=>{
  e.preventDefault();dropArea.classList.remove('dragover');handleFiles(e.dataTransfer.files);
});
fileInput.onchange=e=>handleFiles(e.target.files);

copyBtn.onclick=()=>{
  navigator.clipboard.writeText(linkBox.textContent).then(()=>{
    statusText.textContent='âœ“ ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼';
    statusText.style.color='#2ecc71';
    setTimeout(()=>statusText.textContent='',3000);
  });
};

// === åˆæœŸåŒ– ===
window.addEventListener('load',async()=>{
  await initDatabase();
});
</script>
</body>
</html>
