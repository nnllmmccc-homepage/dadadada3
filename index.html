<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>住所特定 v2 簡易版</title>
<style>
body { font-family: sans-serif; background:#f0f0f0; text-align:center; padding:50px; }
button { padding:10px 20px; font-size:16px; margin:5px; cursor:pointer; }
#info { margin-top:20px; background:#fff; padding:20px; border-radius:10px; display:inline-block; }
</style>
</head>
<body>

<h1>住所特定 v2 簡易版</h1>

<button id="createLink">リンクを作成</button>
<div id="linkContainer"></div>

<div id="info"></div>

<script>
// ----- 個別リンク作成 -----
const createBtn = document.getElementById('createLink');
const linkContainer = document.getElementById('linkContainer');

createBtn.onclick = () => {
    const uniqueId = Date.now();
    const url = `${location.origin}${location.pathname}?id=${uniqueId}`;
    localStorage.setItem('linkCreatedTime_' + uniqueId, Date.now());
    linkContainer.innerHTML = `生成リンク（20分で無効）：<br><a href="${url}" target="_blank">${url}</a>`;
}

// ----- アクセス者情報取得 -----
async function showVisitorInfo() {
    const infoDiv = document.getElementById('info');

    // URLパラメータチェック
    const params = new URLSearchParams(location.search);
    const id = params.get('id');
    if (!id) {
        infoDiv.innerHTML = 'リンクをクリックしてアクセスしてください。';
        return;
    }

    // 20分期限チェック
    const createdTime = localStorage.getItem('linkCreatedTime_' + id);
    if (createdTime && (Date.now() - createdTime > 20*60*1000)) {
        infoDiv.innerHTML = 'このリンクは期限切れです。';
        return;
    }

    // 5分待機チェック（擬似）
    const firstVisitTimeKey = 'firstVisit_' + id;
    const firstVisit = localStorage.getItem(firstVisitTimeKey) || Date.now();
    localStorage.setItem(firstVisitTimeKey, firstVisit);

    const waitSec = 5*60 - Math.floor((Date.now() - firstVisit)/1000);
    if (waitSec > 0) {
        infoDiv.innerHTML = `アクセス後5分経過していません。あと ${waitSec} 秒待ってください。`;
        setTimeout(showVisitorInfo, 1000);
        return;
    }

    // IP 情報取得（外部API）
    try {
        const res = await fetch('https://ipapi.co/json/');
        const data = await res.json();
        infoDiv.innerHTML = `
            <strong>アクセス者情報:</strong><br>
            IP: ${data.ip}<br>
            国: ${data.country_name}<br>
            都道府県: ${data.region}<br>
            市区町村: ${data.city}<br>
            緯度: ${data.latitude}, 経度: ${data.longitude}
        `;
    } catch(e) {
        infoDiv.innerHTML = '情報取得に失敗しました。';
    }
}

showVisitorInfo();
</script>

</body>
</html>
