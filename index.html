<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Universal HTML Preview</title>
<style>
body{background:#0f1724;color:#e6eef8;font-family:sans-serif;margin:0;padding:28px}
.card{background:#0b1220;border-radius:12px;max-width:950px;margin:auto;padding:22px;box-shadow:0 8px 35px rgba(0,0,0,.5)}
input[type=url]{width:100%;padding:12px;background:#071423;border:1px solid #1f2b3a;border-radius:8px;color:#fff}
button,input[type=submit]{padding:10px 14px;border-radius:8px;border:0;background:#2563eb;color:#fff;font-weight:600;cursor:pointer;margin-top:8px}
#error{white-space:pre-wrap;margin-top:16px;color:#ff7373}
</style>
</head>
<body>
<div class="card">
<h2>Universal HTML Preview</h2>
<p>GitHub / GitLab / Bitbucket / Raw / jsDelivr / 任意URL 全部プレビューできます。</p>

<form onsubmit="location.href='?'+encodeURIComponent(document.getElementById('url').value);return false;">
  <input id="url" type="url" placeholder="HTML ファイルの URL を入力（何でもOK）" autofocus>
  <input type="submit" value="Preview">
</form>

<div id="error"></div>
</div>

<script>
(function(){

// ==============================================
// 1)  プレビュー対象の URL を取得
// ==============================================
let raw = decodeURIComponent(location.search.substring(1));
if(!raw){ return; }
let target = raw;


// ==============================================
// 2)  GitHub / GitLab / Bitbucket を RAW 自動変換
// ==============================================
function toRawURL(url){

  // GitHub
  if(url.includes("github.com") && url.includes("/blob/")){
    return url.replace("github.com","raw.githubusercontent.com").replace("/blob/","/");
  }

  // GitLab
  if(url.includes("gitlab.com") && url.includes("/-/blob/")){
    return url.replace("/-/blob/","/-/raw/");
  }

  // Bitbucket
  if(url.includes("bitbucket.org") && url.includes("/src/")){
    return url.replace("/src/","/raw/");
  }

  return url;
}

target = toRawURL(target);


// ==============================================
// 3)  万能 CORS プロキシ（3段フェイルオーバー）
// ==============================================
let PROXIES = [
  "https://cors-anywhere.herokuapp.com/",
  "https://api.allorigins.win/raw?url=",
  "https://api.codetabs.com/v1/proxy/?quest="
];

function fetchAny(url,i=0){
  return fetch(PROXIES[i]+url)
    .then(r=>{
      if(!r.ok) throw new Error();
      return r.text();
    })
    .catch(e=>{
      if(i>=PROXIES.length-1) throw e;
      return fetchAny(url,i+1);
    });
}


// ==============================================
// 4)  HTML 読み込んで書き換え（CSS/JS 全対応）
// ==============================================
function injectHTML(html){

  // <base> を挿入（相対パスを修正）
  html = html.replace(/<head([^>]*)>/i,
    `<head$1><base href="${target}">`);

  // script をブラウザで即実行されないように変更
  html = html.replace(/<script/gi,'<script type="text/htmlpreview"');

  setTimeout(()=>{
    document.open();
    document.write(html);
    document.close();

    rewriteAssets();
  },20);
}


// ==============================================
// 5)  ページ内部のリンク・CSS・JS をすべて書き換え
// ==============================================
function rewriteAssets(){

  // iframe
  document.querySelectorAll("iframe[src],frame[src]").forEach(f=>{
    let src=f.src;
    if(!src) return;
    if(src.startsWith("http")){
      f.src = location.origin + location.pathname + "?" + src;
    }
  });

  // a[href]
  document.querySelectorAll("a[href]").forEach(a=>{
    let h=a.href;
    if(h.endsWith(".html") || h.endsWith(".htm")){
      a.href = location.origin+location.pathname+"?"+h;
    }
  });

  // CSS
  document.querySelectorAll('link[rel="stylesheet"]').forEach(link=>{
    let href=link.href;
    if(!href) return;
    fetchAny(href).then(css=>{
      let style=document.createElement("style");
      style.innerHTML=css;
      document.head.appendChild(style);
    });
    link.remove();
  });

  // JS
  let scripts = document.querySelectorAll('script[type="text/htmlpreview"]');
  let load = Promise.resolve();

  scripts.forEach(sc=>{
    load = load.then(()=>{
      if(sc.src){
        return fetchAny(sc.src).then(code=>{
          let s=document.createElement("script");
          s.innerHTML=code;
          document.body.appendChild(s);
        });
      } else {
        let s=document.createElement("script");
        s.innerHTML=sc.innerHTML;
        document.body.appendChild(s);
      }
    });
  });

  load.then(()=>{
    try{
      document.dispatchEvent(new Event("DOMContentLoaded"));
    }catch(e){}
  });

}


// ==============================================
// 6) 実行
// ==============================================
fetchAny(target)
  .then(injectHTML)
  .catch(e=>{
    document.getElementById("error").textContent =
      "読み込みに失敗: "+target+"\n\n"+e;
  });

})();
</script>
</body>
</html>
