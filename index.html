<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ€ãƒ¼</title>
<meta property="og:type" content="website">
<meta property="og:title" content="ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ€ãƒ¼">
<meta property="og:description" content="ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦å…±æœ‰ã—ã¾ã—ã‚‡ã†">
<meta property="og:site_name" content="ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ€ãƒ¼">
<style>
/* ã‚ãªãŸã®CSSãã®ã¾ã¾ï¼ˆçœç•¥ãªã—ï¼‰ */
</style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“¸ ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ€ãƒ¼</h1>
        <div class="upload-container">
            <div class="drop-area" id="dropArea">
                <div style="font-size: 48px;">ğŸ“</div>
                <p style="margin: 10px 0;">ã“ã“ã«ç”»åƒã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</p>
                <p style="margin: 10px 0;">ã¾ãŸã¯</p>
                <input type="file" id="fileInput" class="file-input" accept="image/*">
                <button class="btn" id="selectBtn">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</button>
            </div>
        </div>
        <div class="result-container" id="resultContainer">
            <h2>âœ… ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸï¼</h2>
            <div style="position: relative;">
                <img id="previewImg" class="thumbnail" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼">
            </div>
            <p>å…±æœ‰ãƒªãƒ³ã‚¯:</p>
            <div class="link-box" id="linkBox"></div>
            <button class="btn copy-btn" id="copyBtn">ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼</button>
            <p class="status-text" id="statusText"></p>
        </div>
        <div class="gallery" id="gallery" style="display: none;">
            <h2>ğŸ“‚ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å±¥æ­´</h2>
            <div class="image-grid" id="imageGrid"></div>
        </div>
    </div>

<script>
const dropArea = document.getElementById('dropArea');
const fileInput = document.getElementById('fileInput');
const selectBtn = document.getElementById('selectBtn');
const resultContainer = document.getElementById('resultContainer');
const previewImg = document.getElementById('previewImg');
const linkBox = document.getElementById('linkBox');
const copyBtn = document.getElementById('copyBtn');
const statusText = document.getElementById('statusText');
const gallery = document.getElementById('gallery');
const imageGrid = document.getElementById('imageGrid');

const currentBaseUrl = window.location.origin + window.location.pathname.replace(/\/$/, '');
let db;
const DB_NAME = 'ImageUploaderDB';
const DB_VERSION = 3;
const STORE_NAME = 'images';

// âœ… IndexedDB åˆæœŸåŒ–ï¼ˆä¿®æ­£ç‰ˆï¼šdbã‚’ç¢ºå®Ÿã«ä»£å…¥ã—ã¦ã‹ã‚‰è§£æ±ºï¼‰
async function initDatabase() {
    if (db) return; // æ—¢ã«é–‹ã„ã¦ã„ã‚Œã°å†åˆæœŸåŒ–ã—ãªã„
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
            db = request.result;
            resolve();
        };
        request.onupgradeneeded = (event) => {
            const db = event.target.result;
            if (!db.objectStoreNames.contains(STORE_NAME)) {
                const store = db.createObjectStore(STORE_NAME, { keyPath: 'shortId' });
                store.createIndex('timestamp', 'timestamp', { unique: false });
            }
        };
    });
}

// ä»¥ä¸‹ã¯ã™ã¹ã¦å…ƒã®é–¢æ•°ãã®ã¾ã¾
function generateShortId() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let result = '';
    for (let i = 0; i < 7; i++) result += chars.charAt(Math.floor(Math.random() * chars.length));
    return result;
}
async function saveImageToDB(file, imageData) {
    return new Promise(async (resolve, reject) => {
        try {
            let shortId = generateShortId();
            let attempts = 0;
            const maxAttempts = 10;
            while (attempts < maxAttempts) {
                const existing = await getImageByShortId(shortId);
                if (!existing) break;
                shortId = generateShortId();
                attempts++;
            }
            if (attempts >= maxAttempts) return reject(new Error('IDç”Ÿæˆå¤±æ•—'));
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            const imageRecord = {
                shortId, filename: file.name, type: file.type, size: file.size,
                data: imageData, timestamp: Date.now()
            };
            const request = store.add(imageRecord);
            request.onsuccess = () => resolve(shortId);
            request.onerror = () => reject(request.error);
        } catch (error) {
            reject(error);
        }
    });
}
async function getImageByShortId(shortId) {
    return new Promise((resolve, reject) => {
        const tx = db.transaction([STORE_NAME], 'readonly');
        const store = tx.objectStore(STORE_NAME);
        const req = store.get(shortId);
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
    });
}
async function getAllImages() {
    return new Promise((resolve, reject) => {
        const tx = db.transaction([STORE_NAME], 'readonly');
        const store = tx.objectStore(STORE_NAME);
        const req = store.getAll();
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
    });
}
async function updateGallery() {
    try {
        const images = await getAllImages();
        if (images.length > 0) {
            gallery.style.display = 'block';
            imageGrid.innerHTML = '';
            images.sort((a, b) => b.timestamp - a.timestamp).forEach(image => {
                const imgElement = document.createElement('div');
                imgElement.className = 'image-item';
                const img = document.createElement('img');
                img.src = image.data;
                img.alt = image.filename;
                img.dataset.shareUrl = `${currentBaseUrl}/${image.shortId}`;
                imgElement.appendChild(img);
                imgElement.addEventListener('click', (e) => {
                    e.preventDefault(); viewImage(image.shortId);
                });
                imageGrid.appendChild(imgElement);
            });
        }
    } catch (e) { console.error(e); }
}
function viewImage(shortId) {
    getImageByShortId(shortId).then(image => {
        if (!image) return;
        document.querySelector('.container').style.display = 'none';
        const viewMode = document.createElement('div');
        viewMode.className = 'view-mode';
        const img = document.createElement('img');
        img.src = image.data;
        const exitHint = document.createElement('div');
        exitHint.className = 'exit-hint';
        exitHint.textContent = 'ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ESCã§é–‰ã˜ã‚‹';
        viewMode.append(img, exitHint);
        document.body.appendChild(viewMode);
        viewMode.addEventListener('click', () => {
            viewMode.remove();
            document.querySelector('.container').style.display = 'block';
        });
    });
}

// âœ… ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ»ãƒ‰ãƒ©ãƒƒã‚°å‰ã«DBåˆæœŸåŒ–ã‚’ä¿è¨¼
selectBtn.addEventListener('click', async () => {
    await initDatabase();
    fileInput.click();
});
fileInput.addEventListener('change', async (e) => {
    await initDatabase();
    handleFiles(e.target.files);
});
dropArea.addEventListener('drop', async (e) => {
    e.preventDefault();
    await initDatabase();
    handleFiles(e.dataTransfer.files);
});

async function handleFiles(files) {
    if (!files || files.length === 0) return;
    const file = files[0];
    if (!file.type.startsWith('image/')) {
        alert('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
    }
    const reader = new FileReader();
    reader.onload = async (e) => {
        const imageData = e.target.result;
        try {
            const shortId = await saveImageToDB(file, imageData);
            const shareLink = `${currentBaseUrl}/${shortId}`;
            previewImg.src = imageData;
            linkBox.textContent = shareLink;
            resultContainer.style.display = 'block';
            statusText.textContent = '';
            await updateGallery();
        } catch (err) {
            statusText.textContent = 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ';
        }
    };
    reader.readAsDataURL(file);
}

// ã‚³ãƒ”ãƒ¼ï¼ˆå…ƒã®ã¾ã¾ï¼‰
copyBtn.addEventListener('click', () => {
    const link = linkBox.textContent;
    navigator.clipboard.writeText(link).then(() => {
        statusText.textContent = 'âœ“ ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ';
        statusText.style.color = '#2ecc71';
        setTimeout(() => { statusText.textContent = ''; statusText.style.color = ''; }, 3000);
    }).catch(() => alert('ã‚³ãƒ”ãƒ¼å¤±æ•—'));
});

// èµ·å‹•æ™‚
window.addEventListener('load', async () => {
    await initDatabase();
    await updateGallery();
});
</script>
</body>
</html>
