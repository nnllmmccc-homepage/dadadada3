<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Universal HTML Preview</title>
<style>
body{
  background:linear-gradient(135deg,#1a0a0f 0%,#2d0a14 50%,#1a0a0f 100%);
  color:#ff6b6b;
  font-family:'Segoe UI',sans-serif;
  margin:0;
  padding:28px;
  min-height:100vh;
}
.card{
  background:rgba(20,5,10,.95);
  border-radius:16px;
  max-width:950px;
  margin:auto;
  padding:32px;
  box-shadow:0 12px 48px rgba(255,0,50,.3),0 0 80px rgba(255,0,0,.1);
  border:2px solid rgba(255,50,50,.3);
  backdrop-filter:blur(10px);
}
h2{
  color:#ff3838;
  text-shadow:0 0 20px rgba(255,50,50,.6);
  margin-top:0;
  font-size:2em;
  letter-spacing:1px;
}
p{color:#ffb3b3;line-height:1.6}
input[type=url]{
  width:100%;
  padding:14px 18px;
  background:rgba(10,0,5,.8);
  border:2px solid #ff3838;
  border-radius:10px;
  color:#fff;
  font-size:15px;
  transition:all .3s;
  box-sizing:border-box;
}
input[type=url]:focus{
  outline:none;
  border-color:#ff6b6b;
  box-shadow:0 0 20px rgba(255,50,50,.4);
}
button,input[type=submit]{
  padding:12px 28px;
  border-radius:10px;
  border:0;
  background:linear-gradient(135deg,#ff3838,#c41e3a);
  color:#fff;
  font-weight:700;
  cursor:pointer;
  margin-top:12px;
  font-size:15px;
  transition:all .3s;
  text-transform:uppercase;
  letter-spacing:1px;
  box-shadow:0 4px 15px rgba(255,50,50,.4);
}
button:hover,input[type=submit]:hover{
  transform:translateY(-2px);
  box-shadow:0 6px 25px rgba(255,50,50,.6);
  background:linear-gradient(135deg,#ff5050,#d41e3a);
}
#error{
  white-space:pre-wrap;
  margin-top:20px;
  color:#ff4444;
  background:rgba(255,0,0,.1);
  padding:16px;
  border-radius:8px;
  border-left:4px solid #ff3838;
}
.status{
  margin-top:16px;
  padding:12px;
  background:rgba(255,100,100,.1);
  border-radius:8px;
  border-left:4px solid #ff6b6b;
  color:#ffb3b3;
}
</style>
</head>
<body>
<div class="card">
<h2>ğŸ”¥ Universal HTML Preview</h2>
<p>GitHub / GitLab / Bitbucket / Raw / jsDelivr / ä»»æ„URL å…¨éƒ¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ãã¾ã™ã€‚</p>

<form onsubmit="location.href='?'+encodeURIComponent(document.getElementById('url').value);return false;">
  <input id="url" type="url" placeholder="HTML ãƒ•ã‚¡ã‚¤ãƒ«ã® URL ã‚’å…¥åŠ›ï¼ˆä½•ã§ã‚‚OKï¼‰" autofocus>
  <input type="submit" value="ğŸš€ Preview">
</form>

<div id="status"></div>
<div id="error"></div>
</div>

<script>
(function(){

// ==============================================
// 1) ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡ã® URL ã‚’å–å¾—
// ==============================================
let raw = decodeURIComponent(location.search.substring(1));
if(!raw){ return; }
let target = raw;

showStatus("èª­ã¿è¾¼ã¿ä¸­: " + target);


// ==============================================
// 2) GitHub / GitLab / Bitbucket ã‚’ RAW è‡ªå‹•å¤‰æ›
// ==============================================
function toRawURL(url){
  // GitHub
  if(url.includes("github.com") && url.includes("/blob/")){
    return url.replace("github.com","raw.githubusercontent.com").replace("/blob/","/");
  }
  
  // GitLab
  if(url.includes("gitlab.com") && url.includes("/-/blob/")){
    return url.replace("/-/blob/","/-/raw/");
  }
  
  // Bitbucket
  if(url.includes("bitbucket.org") && url.includes("/src/")){
    return url.replace("/src/","/raw/");
  }
  
  return url;
}

target = toRawURL(target);


// ==============================================
// 3) ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
// ==============================================
function showStatus(msg){
  const el = document.getElementById("status");
  if(el){
    el.innerHTML = msg;
    el.style.display = "block";
  }
}

function hideStatus(){
  const el = document.getElementById("status");
  if(el) el.style.display = "none";
}


// ==============================================
// 4) æ”¹å–„ã•ã‚ŒãŸ CORS ãƒ—ãƒ­ã‚­ã‚·ï¼ˆè¤‡æ•°ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼ï¼‰
// ==============================================
let PROXIES = [
  url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
  url => `https://corsproxy.io/?${encodeURIComponent(url)}`,
  url => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`
];

function fetchWithProxy(url, proxyIndex = 0){
  if(proxyIndex >= PROXIES.length){
    return fetch(url); // æœ€å¾Œã¯ç›´æ¥è©¦è¡Œ
  }
  
  const proxyURL = PROXIES[proxyIndex](url);
  
  return fetch(proxyURL, {
    method: 'GET',
    headers: {'Accept': '*/*'}
  })
  .then(r => {
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    return r.text();
  })
  .catch(e => {
    console.warn(`Proxy ${proxyIndex} failed for ${url}:`, e);
    return fetchWithProxy(url, proxyIndex + 1);
  });
}


// ==============================================
// 5) URL è§£æ±ºï¼ˆç›¸å¯¾ãƒ‘ã‚¹å¯¾å¿œï¼‰
// ==============================================
function resolveURL(base, relative){
  try {
    return new URL(relative, base).href;
  } catch(e) {
    return relative;
  }
}


// ==============================================
// 6) HTML èª­ã¿è¾¼ã‚“ã§æ›¸ãæ›ãˆï¼ˆCSS/JS å…¨å¯¾å¿œï¼‰
// ==============================================
function injectHTML(html){
  // base ã‚¿ã‚°ã‚’æŒ¿å…¥ï¼ˆç›¸å¯¾ãƒ‘ã‚¹ã‚’ä¿®æ­£ï¼‰
  const baseDir = target.substring(0, target.lastIndexOf('/') + 1);
  html = html.replace(/<head([^>]*)>/i, `<head$1><base href="${baseDir}">`);
  
  // script ã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–
  html = html.replace(/<script/gi, '<script type="text/htmlpreview"');
  
  setTimeout(() => {
    document.open();
    document.write(html);
    document.close();
    
    setTimeout(() => {
      rewriteAssets();
      hideStatus();
    }, 100);
  }, 20);
}


// ==============================================
// 7) ãƒšãƒ¼ã‚¸å†…éƒ¨ã®ãƒªãƒ³ã‚¯ãƒ»CSSãƒ»JS ã‚’ã™ã¹ã¦æ›¸ãæ›ãˆ
// ==============================================
function rewriteAssets(){
  const baseDir = target.substring(0, target.lastIndexOf('/') + 1);
  
  // iframe/frame
  document.querySelectorAll("iframe[src],frame[src]").forEach(f => {
    let src = f.getAttribute('src');
    if(!src) return;
    
    const resolved = resolveURL(baseDir, src);
    if(resolved.startsWith("http")){
      f.src = location.origin + location.pathname + "?" + encodeURIComponent(resolved);
    }
  });
  
  // a[href]
  document.querySelectorAll("a[href]").forEach(a => {
    let h = a.getAttribute('href');
    if(!h || h.startsWith('#') || h.startsWith('javascript:')) return;
    
    const resolved = resolveURL(baseDir, h);
    if(resolved.endsWith(".html") || resolved.endsWith(".htm")){
      a.href = location.origin + location.pathname + "?" + encodeURIComponent(resolved);
    }
  });
  
  // CSSï¼ˆlink ã‚¿ã‚°ï¼‰
  const cssLinks = Array.from(document.querySelectorAll('link[rel="stylesheet"]'));
  cssLinks.forEach(link => {
    let href = link.getAttribute('href');
    if(!href) return;
    
    const resolved = resolveURL(baseDir, href);
    
    fetchWithProxy(resolved)
      .then(css => {
        const style = document.createElement("style");
        style.innerHTML = css;
        document.head.appendChild(style);
      })
      .catch(e => {
        console.error("CSS load failed:", resolved, e);
      });
    
    link.remove();
  });
  
  // JSï¼ˆscript ã‚¿ã‚°ï¼‰
  const scripts = Array.from(document.querySelectorAll('script[type="text/htmlpreview"]'));
  let loadChain = Promise.resolve();
  
  scripts.forEach(sc => {
    loadChain = loadChain.then(() => {
      if(sc.src || sc.getAttribute('src')){
        const src = sc.getAttribute('src');
        const resolved = resolveURL(baseDir, src);
        
        return fetchWithProxy(resolved)
          .then(code => {
            const s = document.createElement("script");
            s.textContent = code;
            document.body.appendChild(s);
          })
          .catch(e => {
            console.error("JS load failed:", resolved, e);
          });
      } else {
        const s = document.createElement("script");
        s.textContent = sc.textContent;
        document.body.appendChild(s);
        return Promise.resolve();
      }
    });
  });
  
  loadChain.then(() => {
    try {
      const event = new Event("DOMContentLoaded");
      document.dispatchEvent(event);
      
      if(typeof window.onload === 'function'){
        window.onload();
      }
    } catch(e) {
      console.error("Event dispatch error:", e);
    }
  });
}


// ==============================================
// 8) å®Ÿè¡Œ
// ==============================================
fetchWithProxy(target)
  .then(html => {
    if(!html || html.trim().length === 0){
      throw new Error("ç©ºã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹");
    }
    injectHTML(html);
  })
  .catch(e => {
    hideStatus();
    document.getElementById("error").textContent = 
      "âŒ èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ\n\n" +
      "URL: " + target + "\n" +
      "ã‚¨ãƒ©ãƒ¼: " + (e.message || e) + "\n\n" +
      "- URL ãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„\n" +
      "- CORS ã‚¨ãƒ©ãƒ¼ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™\n" +
      "- GitHub ã®å ´åˆã¯ /blob/ ã‚’å«ã‚€ URL ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„";
  });

})();
</script>
</body>
</html>
