<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ€ãƒ¼</title>

<meta property="og:type" content="website">
<meta property="og:title" content="ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ€ãƒ¼">
<meta property="og:description" content="ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦å…±æœ‰ã—ã¾ã—ã‚‡ã†">
<meta property="og:site_name" content="ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ€ãƒ¼">

<style>
/* --- ã“ã“ã¯å…¨ãåŒã˜ --- */
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;max-width:1000px;margin:0 auto;padding:20px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;color:#333}
.container{background:white;border-radius:15px;padding:30px;box-shadow:0 10px 30px rgba(0,0,0,0.2);margin:20px 0}
h1{color:#2c3e50;text-align:center;margin-bottom:30px;font-size:2.2em}
.drop-area{border:3px dashed #3498db;border-radius:10px;padding:40px;text-align:center;cursor:pointer;transition:all .3s ease;background:#f8f9fa}
.drop-area:hover,.drop-area.dragover{background:#e3f2fd;border-color:#2980b9;transform:translateY(-2px)}
.file-input{display:none}
.btn{background:linear-gradient(45deg,#3498db,#2980b9);color:white;border:none;padding:12px 25px;border-radius:25px;cursor:pointer;font-size:16px;margin-top:15px;transition:all .3s ease;box-shadow:0 4px 15px rgba(52,152,219,.3)}
.btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(52,152,219,.4)}
.result-container{display:none;background:#fff;border-radius:10px;padding:25px;box-shadow:0 5px 15px rgba(0,0,0,.1);margin-top:20px;animation:fadeIn .5s ease}
.thumbnail{max-width:100%;max-height:300px;margin:15px 0;border-radius:8px;box-shadow:0 4px 10px rgba(0,0,0,.1)}
.link-box{background:#f8f9fa;border:2px solid #e9ecef;border-radius:8px;padding:15px;margin:20px 0;word-break:break-all;font-family:monospace;font-size:14px}
.copy-btn{background:linear-gradient(45deg,#2ecc71,#27ae60);box-shadow:0 4px 15px rgba(46,204,113,.3)}
.copy-btn:hover{box-shadow:0 6px 20px rgba(46,204,113,.4)}
.status-text{margin-top:15px;color:#6c757d;font-size:14px}
.gallery{margin-top:40px}
.image-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:15px;margin-top:20px}
.image-item{border-radius:8px;overflow:hidden;box-shadow:0 4px 8px rgba(0,0,0,.2);transition:transform .3s ease;cursor:pointer;position:relative}
.image-item:hover{transform:scale(1.05)}
.image-item img{width:100%;height:120px;object-fit:cover;display:block}
.view-mode{position:fixed;top:0;left:0;width:100vw;height:100vh;background:#000;display:flex;justify-content:center;align-items:center;z-index:10000;overflow:hidden}
.view-mode img{max-width:100vw;max-height:100vh;object-fit:contain}
.image-direct{margin:0;padding:0;width:100vw;height:100vh;display:flex;justify-content:center;align-items:center;background:#000}
.image-direct img{max-width:100%;max-height:100%;object-fit:contain}
@keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
::-webkit-scrollbar{display:none}
body{-ms-overflow-style:none;scrollbar-width:none}
</style>
</head>
<body>
<div class="container">
    <h1>ğŸ“¸ ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ€ãƒ¼</h1>
    <div class="drop-area" id="dropArea">
        <div style="font-size:48px;">ğŸ“</div>
        <p style="margin:10px 0;">ã“ã“ã«ç”»åƒã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</p>
        <p style="margin:10px 0;">ã¾ãŸã¯</p>
        <input type="file" id="fileInput" class="file-input" accept="image/*">
        <button class="btn" id="selectBtn">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</button>
    </div>

    <div class="result-container" id="resultContainer">
        <h2>âœ… ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸï¼</h2>
        <img id="previewImg" class="thumbnail" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼">
        <p>å…±æœ‰ãƒªãƒ³ã‚¯:</p>
        <div class="link-box" id="linkBox"></div>
        <button class="btn copy-btn" id="copyBtn">ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼</button>
        <p class="status-text" id="statusText"></p>
    </div>

    <div class="gallery" id="gallery" style="display:none;">
        <h2>ğŸ“‚ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å±¥æ­´</h2>
        <div class="image-grid" id="imageGrid"></div>
    </div>
</div>

<script>
const dropArea=document.getElementById('dropArea');
const fileInput=document.getElementById('fileInput');
const selectBtn=document.getElementById('selectBtn');
const resultContainer=document.getElementById('resultContainer');
const previewImg=document.getElementById('previewImg');
const linkBox=document.getElementById('linkBox');
const copyBtn=document.getElementById('copyBtn');
const statusText=document.getElementById('statusText');
const gallery=document.getElementById('gallery');
const imageGrid=document.getElementById('imageGrid');

const currentBaseUrl=window.location.origin+window.location.pathname.replace(/\/$/,'');
let db;
const DB_NAME='ImageUploaderDB';
const DB_VERSION=3;
const STORE_NAME='images';

// === IndexedDB åˆæœŸåŒ– ===
async function initDatabase(){
  return new Promise((resolve,reject)=>{
    const request=indexedDB.open(DB_NAME,DB_VERSION);
    request.onerror=()=>reject(request.error);
    request.onsuccess=()=>{db=request.result;resolve()};
    request.onupgradeneeded=e=>{
      const db=e.target.result;
      if(!db.objectStoreNames.contains(STORE_NAME)){
        const store=db.createObjectStore(STORE_NAME,{keyPath:'shortId'});
        store.createIndex('timestamp','timestamp',{unique:false});
      }
    };
  });
}

function generateShortId(){
  const chars='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  let result='';
  for(let i=0;i<7;i++)result+=chars.charAt(Math.floor(Math.random()*chars.length));
  return result;
}

// === ä¿å­˜ ===
async function saveImageToDB(file,imageData){
  if(!db)await initDatabase(); // DBæœªåˆæœŸåŒ–å¯¾ç­–
  return new Promise(async(resolve,reject)=>{
    try{
      let shortId=generateShortId();
      let attempts=0;
      while(attempts<10){
        const ex=await getImageByShortId(shortId);
        if(!ex)break;
        shortId=generateShortId();attempts++;
      }
      const tx=db.transaction([STORE_NAME],'readwrite');
      const store=tx.objectStore(STORE_NAME);
      const record={shortId,filename:file.name,type:file.type,size:file.size,data:imageData,timestamp:Date.now()};
      const req=store.add(record);
      req.onsuccess=()=>resolve(shortId);
      req.onerror=()=>reject(req.error);
    }catch(e){reject(e);}
  });
}

async function getImageByShortId(id){
  if(!db)return null;
  return new Promise((res,rej)=>{
    const tx=db.transaction([STORE_NAME],'readonly');
    const store=tx.objectStore(STORE_NAME);
    const req=store.get(id);
    req.onsuccess=()=>res(req.result);
    req.onerror=()=>rej(req.error);
  });
}

async function getAllImages(){
  if(!db)return [];
  return new Promise((res,rej)=>{
    const tx=db.transaction([STORE_NAME],'readonly');
    const store=tx.objectStore(STORE_NAME);
    const req=store.getAll();
    req.onsuccess=()=>res(req.result);
    req.onerror=()=>rej(req.error);
  });
}

// === ã‚®ãƒ£ãƒ©ãƒªãƒ¼æ›´æ–° ===
async function updateGallery(){
  try{
    const imgs=await getAllImages();
    if(imgs.length>0){
      gallery.style.display='block';
      imageGrid.innerHTML='';
      imgs.sort((a,b)=>b.timestamp-a.timestamp).forEach(img=>{
        const div=document.createElement('div');
        div.className='image-item';
        const el=document.createElement('img');
        el.src=img.data;el.alt=img.filename;
        el.dataset.shareUrl=`${currentBaseUrl}/${img.shortId}`;
        div.appendChild(el);
        div.onclick=()=>viewImage(img.shortId);
        imageGrid.appendChild(div);
      });
    }
  }catch(e){console.error(e);}
}

function viewImage(id){
  getImageByShortId(id).then(image=>{
    if(!image)return;
    document.querySelector('.container').style.display='none';
    const view=document.createElement('div');
    view.className='view-mode';
    const img=document.createElement('img');
    img.src=image.data;
    view.appendChild(img);
    view.onclick=()=>{view.remove();document.querySelector('.container').style.display='block';};
    document.body.appendChild(view);
  });
}

function getImageIdFromUrl(){
  const path=window.location.pathname;
  const m=path.match(/\/([A-Za-z0-9]{7})$/);
  return m?m[1]:null;
}

// === åˆæœŸåŒ– ===
window.addEventListener('load',async()=>{
  const viewId=getImageIdFromUrl();
  await initDatabase();

  if(viewId){
    const image=await getImageByShortId(viewId);
    document.body.innerHTML='';
    document.body.className='image-direct';
    if(image){
      const img=document.createElement('img');
      img.src=image.data;
      img.alt=image.filename;
      document.body.appendChild(img);
    }else{
      document.body.innerHTML='<div style="color:white;text-align:center;font-size:24px;">ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>';
    }
    return;
  }
  await updateGallery();
});

selectBtn.onclick=()=>fileInput.click();
dropArea.addEventListener('dragover',e=>{e.preventDefault();dropArea.classList.add('dragover');});
dropArea.addEventListener('dragleave',()=>dropArea.classList.remove('dragover'));
dropArea.addEventListener('drop',e=>{
  e.preventDefault();
  dropArea.classList.remove('dragover');
  handleFiles(e.dataTransfer.files);
});
fileInput.onchange=e=>handleFiles(e.target.files);

async function handleFiles(files){
  if(!files.length)return;
  const file=files[0];
  if(!file.type.startsWith('image/')){alert('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');return;}
  const reader=new FileReader();
  reader.onload=async e=>{
    const data=e.target.result;
    await initDatabase();
    try{
      const id=await saveImageToDB(file,data);
      const link=`${currentBaseUrl}/${id}`;
      previewImg.src=data;
      linkBox.textContent=link;
      resultContainer.style.display='block';
      statusText.textContent='';
      await updateGallery();
    }catch(err){
      console.error(err);
      statusText.textContent='ä¿å­˜ã«å¤±æ•—: '+err.message;
    }
  };
  reader.readAsDataURL(file);
}

copyBtn.onclick=()=>{
  const link=linkBox.textContent;
  navigator.clipboard.writeText(link).then(()=>{
    statusText.textContent='âœ“ ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼';
    statusText.style.color='#2ecc71';
    setTimeout(()=>statusText.textContent='',3000);
  });
};
</script>
</body>
</html>
